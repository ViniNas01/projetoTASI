<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Home - ContrataFÃ¡cil</title>
  <link rel="stylesheet" href="/style/style.css" />
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="home-body">
  <!-- CabeÃ§alho -->
  <header class="top-bar">
    <div class="logo">
      ğŸ› ï¸ <span>ContrataFÃ¡cil</span>
    </div>

    <nav class="menu">
      <a href="/meus-servicos">Meus ServiÃ§os</a>
      <a href="/logout">Sair</a>
    </nav>

    <div class="perfil">
      <i data-lucide="user"></i>
      <span><%= cliente.nome %></span>
    </div>
  </header>

  <!-- ConteÃºdo principal -->
  <main class="content">
    <!-- Barra de pesquisa -->
    <section class="search-section">
      <form method="GET" action="/home" id="search-form" autocomplete="off">
        <div style="position:relative;max-width:500px;margin:0 auto;">
          <input id="search-input" type="text" name="q" placeholder="Buscar serviÃ§os ou profissionais..." value="<%= typeof q !== 'undefined' ? q : '' %>" />
        <button type="submit"><i data-lucide="search"></i></button>
          <div id="suggestions" class="autocomplete" style="display:none;"></div>
        </div>
      </form>
    </section>

    <!-- Mensagem quando nÃ£o hÃ¡ resultados -->
    <% if (profissionais.length === 0) { %>
      <div class="no-results" style="text-align:center;margin:18px 0;">
        <% if (typeof q !== 'undefined' && q.trim() !== '') { %>
          Nenhum resultado encontrado para "<strong><%= q %></strong>". Tente outra pesquisa ou verifique a grafia.
        <% } else { %>
          Nenhum profissional disponÃ­vel no momento.
        <% } %>
      </div>
    <% } %>

    <!-- Lista de profissionais -->
    <section class="cards-section">
      <% profissionais.forEach(p => { %>
        <div class="card-profissional">
          <img src="<%= p.imagem %>" alt="<%= p.nome %>" />
          <div class="card-info">
            <h3><%= p.nome %></h3>
            <p class="categoria"><%= p.categoria %></p>
            <p class="detalhe">ğŸ“ <%= p.distancia %> de vocÃª</p>
            <p class="detalhe">â­ <%= p.estrelas %> avaliaÃ§Ãµes</p>
            <form action="/profissional/<%= p.id %>" method="GET">
              <button type="submit" class="btn-contratar">Contratar</button>
            </form>
          </div>
        </div>
      <% }) %>
    </section>
  </main>

  <script>
    lucide.createIcons();

    // Autocomplete simples com debounce
    (function() {
      const input = document.getElementById('search-input');
      const suggestions = document.getElementById('suggestions');
      let timer = null;

      function clearSuggestions(){
        suggestions.innerHTML = '';
        suggestions.style.display = 'none';
      }

      function renderList(items){
        if(!items || items.length === 0){ clearSuggestions(); return; }
        suggestions.innerHTML = items.map(i => `<div class="autocomplete-item" data-id="${i.id}">${i.nome} <small style="color:#666;">â€” ${i.categoria}</small></div>`).join('');
        suggestions.style.display = 'block';
      }

      function fetchSuggestions(q){
        fetch('/api/search?q=' + encodeURIComponent(q))
          .then(r => r.json())
          .then(renderList)
          .catch(()=>{});
      }

      input && input.addEventListener('input', (e) => {
        const v = e.target.value.trim();
        clearTimeout(timer);
        if(!v){ clearSuggestions(); return; }
        timer = setTimeout(()=> fetchSuggestions(v), 250);
      });

      // preencher ao clicar
      suggestions && suggestions.addEventListener('click', (e) => {
        const it = e.target.closest('.autocomplete-item');
        if(!it) return;
        // coloca somente o nome no input
        const text = it.textContent.split('â€”')[0].trim();
        input.value = text;
        clearSuggestions();
        // submeter o formulÃ¡rio
        document.getElementById('search-form').submit();
      });

      // fecha quando clicar fora
      document.addEventListener('click', (e)=>{
        if(!e.target.closest('#suggestions') && !e.target.closest('#search-input')){
          clearSuggestions();
        }
      });
    })();
  </script>
</body>
</html>
