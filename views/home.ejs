<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Home - FacilitaA√≠</title>
  <link rel="stylesheet" href="/style/style.css" />
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="home-body">
  <!-- Cabe√ßalho -->
  <header class="top-bar">
  <div class="logo">
    üõ†Ô∏è <span>FacilitaA√≠</span>
  </div>

  <div class="perfil-area">
    <div class="perfil" id="perfil-toggle">
      <i data-lucide="user"></i>
      <span><%= cliente.nome %></span>
      <i data-lucide="chevron-down" class="seta"></i>
    </div>

    <div class="dropdown" id="perfil-dropdown">
      <a href="/meus-servicos">Meus Servi√ßos</a>
      <a href="/logout">Sair</a>
    </div>
  </div>
</header>


  <!-- Conte√∫do principal -->
  <main class="content">
    <!-- Barra de pesquisa -->
    <section class="search-section">
      <form method="GET" action="/home" id="search-form" autocomplete="off">
        <div style="position:relative;max-width:500px;margin:0 auto;">
          <input id="search-input" type="text" name="q" placeholder="Buscar servi√ßos ou profissionais..." value="<%= typeof q !== 'undefined' ? q : '' %>" />
        <button type="submit"><i data-lucide="search"></i></button>
          <div id="suggestions" class="autocomplete" style="display:none;"></div>
        </div>
      </form>
    </section>

    <!-- Mensagem quando n√£o h√° resultados -->
    <% if (profissionais.length === 0) { %>
      <div class="no-results" style="text-align:center;margin:18px 0;">
        <% if (typeof q !== 'undefined' && q.trim() !== '') { %>
          Nenhum resultado encontrado para "<strong><%= q %></strong>". Tente outra pesquisa ou verifique a grafia.
        <% } else { %>
          Nenhum profissional dispon√≠vel no momento.
        <% } %>
      </div>
    <% } %>

    <!-- Lista de profissionais -->
    <section class="cards-section">
      <% profissionais.forEach(p => { %>
        <div class="card-profissional">
          <img src="<%= p.imagem %>" alt="<%= p.nome %>" />
          <div class="card-info">
            <h3><%= p.nome %></h3>
            <p class="categoria"><%= p.categoria %></p>
            <p class="detalhe">üìç <%= p.distancia %> de voc√™</p>
            <p class="detalhe">‚≠ê <%= p.estrelas %> avalia√ß√µes</p>
            <form action="/profissional/<%= p.id %>" method="GET">
              <button type="submit" class="btn-contratar">Contratar</button>
            </form>
          </div>
        </div>
      <% }) %>
    </section>
  </main>

  <script>
    lucide.createIcons();

    // Autocomplete simples com debounce
    (function() {
      const input = document.getElementById('search-input');
      const suggestions = document.getElementById('suggestions');
      let timer = null;

      function clearSuggestions(){
        suggestions.innerHTML = '';
        suggestions.style.display = 'none';
      }

      function renderList(items){
        if(!items || items.length === 0){ clearSuggestions(); return; }
        suggestions.innerHTML = items.map(i => `<div class="autocomplete-item" data-id="${i.id}">${i.nome} <small style="color:#666;">‚Äî ${i.categoria}</small></div>`).join('');
        suggestions.style.display = 'block';
      }

      function fetchSuggestions(q){
        fetch('/api/search?q=' + encodeURIComponent(q))
          .then(r => r.json())
          .then(renderList)
          .catch(()=>{});
      }

      input && input.addEventListener('input', (e) => {
        const v = e.target.value.trim();
        clearTimeout(timer);
        if(!v){ clearSuggestions(); return; }
        timer = setTimeout(()=> fetchSuggestions(v), 250);
      });

      // preencher ao clicar
      suggestions && suggestions.addEventListener('click', (e) => {
        const it = e.target.closest('.autocomplete-item');
        if(!it) return;
        // coloca somente o nome no input
        const text = it.textContent.split('‚Äî')[0].trim();
        input.value = text;
        clearSuggestions();
        // submeter o formul√°rio
        document.getElementById('search-form').submit();
      });

      // fecha quando clicar fora
      document.addEventListener('click', (e)=>{
        if(!e.target.closest('#suggestions') && !e.target.closest('#search-input')){
          clearSuggestions();
        }
      });
    })();
  </script>
  <script>
  lucide.createIcons();

  // Dropdown do perfil
  const perfilToggle = document.getElementById('perfil-toggle');
  const dropdown = document.getElementById('perfil-dropdown');

  perfilToggle.addEventListener('click', () => {
    dropdown.classList.toggle('mostrar');
    perfilToggle.classList.toggle('ativo');
  });

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.perfil-area')) {
      dropdown.classList.remove('mostrar');
      perfilToggle.classList.remove('ativo');
    }
  });
</script>

</body>
</html>
